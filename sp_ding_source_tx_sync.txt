CREATE PROCEDURE sp_ding_source_tx_sync
AS
    DECLARE @initDate DATETIME;
    SELECT  @initDate = '1970-01-01 08:00:00';
    BEGIN TRY
        BEGIN
            INSERT  INTO dbo.Kq_Source
                    ( EmpID ,
                      FType ,
                      CardNo ,
                      MachNo ,
                      FDateTime ,
                      Flag ,
                      Door ,
                      IsDel ,
                      SN ,
                      Remark ,
                      Fdate
                    )
                    SELECT  empid ,
                            ftype ,
                            cardno ,
                            machno ,
                            fdatetime ,
                            flag ,
                            door ,
                            isdel ,
                            sn ,
                            remark ,
                            fdate
                    FROM    ( SELECT DISTINCT
                                        e.ID empid ,
                                        '1' ftype ,
                                        userId cardno ,
                                        '1' machno ,
                                        DATEADD(SECOND,
                                                CONVERT(BIGINT, d.userCheckTime)
                                                / 1000, @initDate) fdatetime ,
                                        NULL flag ,
                                        NULL door ,
                                        NULL isdel ,
                                        NULL sn ,
                                        '钉钉' remark ,
                                        GETDATE() fdate
                              FROM      dbo.ding_kq_source d
                                        JOIN ZlEmployee e ON d.userId = e.Code
                            ) r
                    WHERE   NOT EXISTS ( SELECT 1
                                         FROM   Kq_Source k
                                         WHERE  k.EmpID = r.empid
                                                AND k.FDateTime = r.fdatetime
                                                AND k.MachNo = r.machno
                                                AND k.FDateTime BETWEEN DATEADD(MONTH,
                                                              -1, GETDATE())
                                                              AND
                                                              GETDATE() );
            TRUNCATE TABLE dbo.ding_kq_source;
        END;

    END TRY
    BEGIN CATCH
        BEGIN
            INSERT  INTO dbo.ding_kq_source_error
                    ( gmtModified ,
                      baseCheckTime ,
                      groupId ,
                      timeResult ,
                      classId ,
                      workDate ,
                      planId ,
                      id ,
                      checkType ,
                      planCheckTime ,
                      corpId ,
                      locationResult ,
                      isLegal ,
                      gmtCreate ,
                      userId ,
                      userAddress ,
                      sourceType ,
                      userCheckTime ,
                      locationMethod
                    )
                    SELECT  *
                    FROM    dbo.ding_kq_source;
             --插入log记录
             INSERT INTO ding_sync_error_log(errCode,errProc,errMsg,errTime)
             SELECT ERROR_NUMBER(),'ding_source_tx_sync',ERROR_MESSAGE(),GETDATE()
            TRUNCATE TABLE dbo.ding_kq_source;
        END;
        
    END CATCH;
    
  