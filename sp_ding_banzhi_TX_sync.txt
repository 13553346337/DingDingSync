CREATE PROCEDURE sp_ding_banzhi_TX_sync
AS
    BEGIN
    
    /*插入新增的班次到班次对应表*/
        BEGIN
            INSERT  INTO ding_banzhi_relation
                    ( class_id
                    )
                    SELECT DISTINCT
                            class_id
                    FROM    dbo.ding_kq_banzhi
                    WHERE   class_id NOT IN ( SELECT    class_id
                                              FROM      ding_banzhi_relation );
        END;
        
       /*钉钉班次转成同鑫班制格式*/ 
        BEGIN
            DELETE  dbo.Kq_BanZhi_D
            WHERE   Code IN ( SELECT    tx_banzhi_code
                              FROM      ding_banzhi_relation );
            INSERT  INTO dbo.Kq_BanZhi_D
                    ( Code ,
                      BanCiXh ,
                      SbMaxTime ,
                      SbMaxTime2 ,
                      SbTime ,
                      SbMinTime ,
                      SbMinTime2 ,
                      XbMinTime ,
                      XbMinTime2 ,
                      XbTime ,
                      XbMaxTime ,
                      XbMaxTime2 ,
                      FactTimeFirst1 ,
                      FactTimeFirst2 ,
                      XiuXi ,
                      XiuXi0 ,
                      TcJbMaxSj ,
                      TqJbMaxSj ,
                      IfBjJb ,
                      Zsj ,
                      SjSj ,
                      JiaBan ,
                      IfJbkq ,
                      IfJbkh ,
                      IfFd ,
                      IfSbDk ,
                      IfXbDk ,
                      IfTcjb ,
                      IfTqjb ,
                      IfKg ,
                      IfChiDao ,
                      IfZaoTui ,
                      NotBjJb ,
                      RptColXh
                    )
                    SELECT DISTINCT
                            z.tx_banzhi_code code ,
                            '1' bancixh ,
                            DATEDIFF(MINUTE, '1970-01-01',
                                     CONVERT(DATETIME, d.check_time_on, 120))
                            + 180 sbmaxtime ,
                            NULL sbmaxtime2 ,
                            DATEDIFF(MINUTE, '1970-01-01',
                                     CONVERT(DATETIME, d.check_time_on, 120)) sbtime ,
                            DATEDIFF(MINUTE, '1970-01-01',
                                     CONVERT(DATETIME, d.check_time_on, 120))
                            - 180 sbmintime ,
                            NULL sbmintime2 ,
                            DATEDIFF(MINUTE, '1970-01-01',
                                     CONVERT(DATETIME, d.check_time_off, 120))
                            - 180 xbmintime ,
                            NULL xbmintime2 ,
                            DATEDIFF(MINUTE, '1970-01-01',
                                     CONVERT(DATETIME, d.check_time_off, 120)) xbtime ,
                            DATEDIFF(MINUTE, '1970-01-01',
                                     CONVERT(DATETIME, d.check_time_off, 120))
                            + 180 xbmaxtime ,
                            NULL xbmaxtime2 ,
                            NULL FactTimeFirst1 ,
                            NULL FactTimeFirst2 ,
                            DATEDIFF(MINUTE, '1970-01-01',
                                     CONVERT(DATETIME, d.rest_end_time, 120)) xiuxi ,
                            DATEDIFF(MINUTE, '1970-01-01',
                                     CONVERT(DATETIME, d.rest_begin_time, 120)) xiuxi0 ,
                            NULL TcJbMaxSj ,
                            NULL TqJbMaxSj ,
                            NULL IfBjJb ,
                            NULL Zsj ,
                            NULL SjSj ,
                            NULL JiaBan ,
                            0 IfJbkq ,
                            0 IfJbkh ,
                            NULL IfFd ,
                            NULL IfSbDk ,
                            NULL IfXbDk ,
                            1 IfTcjb ,
                            0 IfTqjb ,
                            1 IfKg ,
                            1 IfChiDao ,
                            1 IfZaoTui ,
                            NULL NotBjJb ,
                            1 RptColXh
                    FROM    ding_kq_banzhi d
                            JOIN ding_banzhi_relation z ON d.class_id = z.class_id
                                                           AND NOT EXISTS ( SELECT
                                                              1
                                                              FROM
                                                              Kq_BanZhi_D k
                                                              WHERE
                                                              k.Code = z.tx_banzhi_code );
        END;
        
        /*钉钉班制插入班制表kq_banzhi*/
        BEGIN
            DELETE  dbo.Kq_BanZhi
            WHERE   Code IN ( SELECT    tx_banzhi_code
                              FROM      ding_banzhi_relation );
                              
            INSERT  INTO dbo.Kq_BanZhi
                    ( Code ,
                      Name ,
                      Zsj ,
                      BanCiCount ,
                      IfFdJcsj ,
                      IfFdjb ,
                      CanZhi ,
                      IfDLJCDZT ,
                      Note ,
                      IfBz ,
                      Czy ,
                      OperateDate ,
                      UseDept ,
                      Color
                    )
                    SELECT  DISTINCT d.Code ,
                            k.class_name ,
                            d.Zsj ,
                            1 bancicount ,
                            0 ifdjcsj ,
                            NULL iffdjb ,
                            NULL canzhi ,
                            NULL ifdljcdzt ,
                            NULL Note ,
                            NULL ifbz ,
                            '钉钉更新' czy ,
                            GETDATE() operationdate ,
                            NULL usedept ,
                            -2147483643 color
                    FROM    dbo.Kq_BanZhi_D d
                            JOIN ding_banzhi_relation r ON d.Code = r.tx_banzhi_code
                            JOIN ( SELECT DISTINCT
                                            class_id ,
                                            class_name
                                   FROM     ding_kq_banzhi
                                 ) k ON r.class_id = k.class_id;
        END;


    END;   
    
